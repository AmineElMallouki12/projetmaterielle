{% extends 'base.html' %}
{% block title %}Reports{% endblock %}
{% block content %}

{% if current_user.role == 'etudiant' %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="alert alert-warning text-center py-5">
        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
        <h4>Accès refusé</h4>
        <p>Les étudiants ne peuvent pas accéder aux rapports et analyses.</p>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
          <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
        </a>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold mb-3">
        <i class="fas fa-chart-bar me-2"></i>Rapports & Analyses
      </h2>
      <p class="text-muted">Générez et consultez des rapports détaillés sur votre système d'inventaire.</p>
    </div>
  </div>

  <!-- Report Type Selection -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-cog me-2"></i>Configuration du rapport
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('generate_report') }}">
            <div class="row">
              <div class="col-md-6">
                <label class="form-label">Type de rapport</label>
                <select name="report_type" class="form-select" onchange="this.form.submit()">
                  <option value="inventory" {% if report_type == 'inventory' %}selected{% endif %}>Rapport d'inventaire</option>
                  <option value="statistics" {% if report_type == 'statistics' %}selected{% endif %}>Statistiques</option>
                  <option value="reservations" {% if report_type == 'reservations' %}selected{% endif %}>Réservations</option>
                </select>
              </div>
              {% if current_user.role != 'etudiant' %}
              <div class="col-md-6">
                <label class="form-label">Format d'export</label>
                <div class="btn-group w-100" role="group">
                  <button type="button" class="btn btn-outline-primary" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf me-2"></i>PDF
                  </button>
                  <button type="button" class="btn btn-outline-success" onclick="exportReport('excel')">
                    <i class="fas fa-file-csv me-2"></i>Excel
                  </button>
                </div>
              </div>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Content -->
  {% if report_type == 'inventory' %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Rapport d'inventaire
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Désignation</th>
                  <th>Marque</th>
                  <th>Modèle</th>
                  <th>N° Série</th>
                  <th>Ancien CAB</th>
                  <th>Nouveau CAB</th>
                  <th>Date d’inventaire</th>
                  <th>Quantité</th>
                  <th>Statut</th>
                  <th>Description / Observation</th>
                </tr>
              </thead>
              <tbody>
                {% for item in items %}
                <tr>
                  <td>{{ item.id }}</td>
                  <td>{{ item.designation }}</td>
                  <td>{{ item.marque }}</td>
                  <td>{{ item.modele }}</td>
                  <td>{{ item.n_serie }}</td>
                  <td>{{ item.ancien_cab }}</td>
                  <td>{{ item.nouveau_cab }}</td>
                  <td>{{ item.date_inv }}</td>
                  <td style="white-space: normal;">{{ item.quantity or 1 }}</td>
                  <td style="white-space: normal;">
                    {% if item.status == 'Disponible' %}
                      <span class="badge bg-success">Disponible</span>
                    {% elif item.status == 'Indisponible' %}
                      <span class="badge bg-danger">Indisponible</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ item.status }}</span>
                    {% endif %}
                  </td>
                  <td style="white-space: normal;">{{ item.description }}</td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="12" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <br>Aucun matériel trouvé
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% elif report_type == 'statistics' %}
  <div class="row">
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-chart-pie me-2"></i>Statistiques du matériel
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="stats-card status-available mb-3">
                <div class="stats-number">{{ stats.available }}</div>
                <div class="stats-label">Disponibles</div>
              </div>
            </div>
            <div class="col-6">
              <div class="stats-card status-unavailable mb-3">
                <div class="stats-number">{{ stats.unavailable }}</div>
                <div class="stats-label">Indisponibles</div>
              </div>
            </div>
            <div class="col-6">
              <div class="stats-card status-repair mb-3">
                <div class="stats-number">{{ stats.repair }}</div>
                <div class="stats-label">Nécessite une réparation</div>
              </div>
            </div>
            <div class="col-6">
              <div class="stats-card mb-3">
                <div class="stats-number">{{ stats.total }}</div>
                <div class="stats-label">Total des éléments</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-percentage me-2"></i>Statistiques d'utilisation
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="mb-3">
                <h4 class="text-primary">{{ "%.1f"|format((stats.available / stats.total * 100) if stats.total > 0 else 0) }}%</h4>
                <small class="text-muted">Taux de disponibilité</small>
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <h4 class="text-warning">{{ "%.1f"|format((stats.repair / stats.total * 100) if stats.total > 0 else 0) }}%</h4>
                <small class="text-muted">Taux de réparation</small>
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <h4 class="text-success">{{ "%.1f"|format((stats.available / stats.total * 100) if stats.total > 0 else 0) }}%</h4>
                <small class="text-muted">Bon état</small>
              </div>
            </div>
            <div class="col-6">
    <div class="mb-3">
                <h4 class="text-info">{{ stats.total }}</h4>
                <small class="text-muted">Total du matériel</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>Répartition des conditions
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 text-center mb-3">
              <div class="border rounded p-3">
                <h3 class="text-success">{{ stats.available }}</h3>
                <p class="mb-0">Bon état</p>
                <small class="text-muted">Fonctionnel</small>
              </div>
            </div>
            <div class="col-md-3 text-center mb-3">
              <div class="border rounded p-3">
                <h3 class="text-warning">{{ stats.repair }}</h3>
                <p class="mb-0">Nécessite une réparation</p>
                <small class="text-muted">Nécessite une maintenance</small>
              </div>
            </div>
            <div class="col-md-3 text-center mb-3">
              <div class="border rounded p-3">
                <h3 class="text-danger">{{ stats.unavailable - stats.repair if stats.unavailable > stats.repair else 0 }}</h3>
                <p class="mb-0">Mauvais état</p>
                <small class="text-muted">Non fonctionnel</small>
              </div>
            </div>
            <div class="col-md-3 text-center mb-3">
              <div class="border rounded p-3">
                <h3 class="text-secondary">{{ stats.total - stats.available - stats.repair - (stats.unavailable - stats.repair if stats.unavailable > stats.repair else 0) }}</h3>
                <p class="mb-0">Autre</p>
                <small class="text-muted">Ancien ou inconnu</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% elif report_type == 'reservations' %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>Rapport des réservations
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted">Les données de réservation seront affichées ici lorsqu'elles seront disponibles.</p>
          <a href="{{ url_for('reservations') }}" class="btn btn-primary">
            <i class="fas fa-calendar-plus me-2"></i>Voir les réservations
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
function exportReport(format) {
    const reportType = document.querySelector('select[name="report_type"]').value;
    if (format === 'pdf' || format === 'excel') {
        let url = `/export-report/${format}?report_type=${reportType}`;
        window.open(url, '_blank');
        return;
    }
    
    // For CSV and JSON exports
    let data = [];
    const table = document.querySelector('table');
    
    if (table) {
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        rows.forEach(row => {
            const cells = Array.from(row.querySelectorAll('td'));
            if (cells.length > 0) {
                const rowData = {};
                cells.forEach((cell, index) => {
                    const header = table.querySelector(`thead th:nth-child(${index + 1})`).textContent;
                    rowData[header] = cell.textContent.trim();
                });
                data.push(rowData);
            }
        });
    }
    
    if (format === 'csv') {
        if (data.length > 0) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => row[header]).join(','))
            ].join('\n');
            downloadFile(csvContent, `${reportType}_report.csv`, 'text/csv');
        } else {
            showAlert('No data to export', 'warning');
        }
    } else if (format === 'json') {
        const jsonContent = JSON.stringify(data, null, 2);
        downloadFile(jsonContent, `${reportType}_report.json`, 'application/json');
    }
}

// Auto-submit form when report type changes
document.querySelector('select[name="report_type"]').addEventListener('change', function() {
    this.form.submit();
});
</script>
{% endif %}
{% endblock %}